<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" type="text/css" href="./styles.css" />
    <script
      src="https://unpkg.com/@babel/standalone@7.25.6/babel.min.js"
      integrity="sha256-aS0B0wnsaDByLfE16h4MDCP1fQFccysd1YWOcV+gbBo="
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
      import React, {
        useState,
        useEffect,
        useRef,
        useLayoutEffect,
      } from 'https://esm.sh/react@18?dev';
      import { createRoot } from 'https://esm.sh/react-dom@18/client?dev';
      import * as zebar from 'https://esm.sh/zebar@3.0';

      const providers = zebar.createProviderGroup({
        media: { type: 'media' },
      });

      createRoot(document.getElementById('root')).render(<App />);

      function App() {
        const [output, setOutput] = useState(providers.outputMap);
        const scrollRef = useRef(null);

        useEffect(() => {
          providers.onOutput(() => setOutput(providers.outputMap));
        }, []);

        const spotifySession = output.media?.allSessions?.find(s =>
          s.sessionId.toLowerCase().includes('spotify'),
        );

        const trackKey = spotifySession
          ? `${spotifySession.title}\0${spotifySession.artist}`
          : '';

        // Set animation duration based on element width for constant scroll speed.
        useLayoutEffect(() => {
          const el = scrollRef.current;
          if (el) {
            const pixelsPerSecond = 50;
            const duration = el.scrollWidth / pixelsPerSecond;
            el.style.animationDuration = `${duration}s`;
          }
        }, [trackKey]);

        if (!spotifySession) {
          return null;
        }

        return (
          <div className="spotify-widget">
            <i className="nf nf-md-spotify spotify-icon"></i>
            <div className="track-info">
              <span key={trackKey} ref={scrollRef} className="track-scroll">
                {spotifySession.title}
                {spotifySession.artist &&
                  ` \u2013 ${spotifySession.artist}`}
              </span>
            </div>
            <div className="controls">
              <button
                className="ctrl-btn"
                onClick={() =>
                  output.media.previous({
                    sessionId: spotifySession.sessionId,
                  })
                }
              >
                <i className="nf nf-md-skip_previous"></i>
              </button>
              <button
                className="ctrl-btn"
                onClick={() =>
                  output.media.togglePlayPause({
                    sessionId: spotifySession.sessionId,
                  })
                }
              >
                <i
                  className={`nf ${
                    spotifySession.isPlaying
                      ? 'nf-md-pause'
                      : 'nf-md-play'
                  }`}
                ></i>
              </button>
              <button
                className="ctrl-btn"
                onClick={() =>
                  output.media.next({
                    sessionId: spotifySession.sessionId,
                  })
                }
              >
                <i className="nf nf-md-skip_next"></i>
              </button>
            </div>
          </div>
        );
      }
    </script>
  </body>
</html>
